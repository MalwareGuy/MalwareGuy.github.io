<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>The Curious Case of MPNotify &amp; NPPSPY - Malware Guy</title>
<meta name="description" content="Today’s hunt was inspired from this awesome blog by Dray Agha! Also a special thanks to Robsware for taking the time out his day to proofread this post! Bug, bother, nudge - show those two horrendously cool blokes all the love you can muster and ask them all about their expert knowledge on lsass.dll!">


  <meta name="author" content="Malware Guy">
  
  <meta property="article:author" content="Malware Guy">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="Malware Guy">
<meta property="og:title" content="The Curious Case of MPNotify &amp; NPPSPY">
<meta property="og:url" content="http://localhost:4000/Hunts/nppspy.html">


  <meta property="og:description" content="Today’s hunt was inspired from this awesome blog by Dray Agha! Also a special thanks to Robsware for taking the time out his day to proofread this post! Bug, bother, nudge - show those two horrendously cool blokes all the love you can muster and ask them all about their expert knowledge on lsass.dll!">



  <meta property="og:image" content="http://localhost:4000/assets/images/banner.png">





  <meta property="article:published_time" content="2023-01-20T00:00:00+00:00">





  

  


<link rel="canonical" href="http://localhost:4000/Hunts/nppspy.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Malware Guy",
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Malware Guy Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Malware Guy
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/posts/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero"
  style=" background-image: url('');"
>
  
    <img src="/assets/images/banner.png" alt="The Curious Case of MPNotify &amp; NPPSPY" class="page__hero-image">
  
  
</div>







<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="http://localhost:4000/">
        <img src="/assets/images/PNGTuber_Malware_Talk.png" alt="Malware Guy" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="http://localhost:4000/" itemprop="url">Malware Guy</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Malware Hunting VTuber</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="https://www.twitch.tv/malware_guy" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-twitch" aria-hidden="true"></i><span class="label">Twitch</span></a></li>
          
        
          
            <li><a href="https://twitter.com/themalwareguy" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/MalwareGuy" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.youtube.com/channel/UCKLRrI3yzes4p8GpWAdwevg" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-youtube" aria-hidden="true"></i><span class="label">YouTube</span></a></li>
          
        
          
            <li><a href="https://discord.gg/kvU3kvt4Qb" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-discord" aria-hidden="true"></i><span class="label">Discord</span></a></li>
          
        
          
            <li><a href="https://infosec.exchange/@malware_guy" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i><span class="label">Mastodon</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="The Curious Case of MPNotify &amp; NPPSPY">
    <meta itemprop="description" content="Today’s hunt was inspired from this awesome blog by Dray Agha! Also a special thanks to Robsware for taking the time out his day to proofread this post! Bug, bother, nudge - show those two horrendously cool blokes all the love you can muster and ask them all about their expert knowledge on lsass.dll!">
    <meta itemprop="datePublished" content="2023-01-20T00:00:00+00:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="http://localhost:4000/Hunts/nppspy.html" class="u-url" itemprop="url">The Curious Case of MPNotify &amp; NPPSPY
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          10 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#detection-and-hunting-methods">Detection and Hunting Methods</a></li><li><a href="#lsassdll-static--dynamic-analysis">‘lsass.dll’ Static &amp; Dynamic Analysis</a><ul><li><a href="#nplogonnotify">NPLogonNotify</a></li></ul></li><li><a href="#yara-time">YARA Time</a></li><li><a href="#mitigations">Mitigations</a></li><li><a href="#final-thoughts">Final Thoughts</a></li><li><a href="#references">References</a></li></ul>

            </nav>
          </aside>
        
        <p>Today’s hunt was inspired from this awesome <a href="https://www.huntress.com/blog/cleartext-shenanigans-gifting-user-passwords-to-adversaries-with-nppspy">blog</a> by <a href="https://twitter.com/Purp1eW0lf">Dray Agha</a>! Also a special thanks to <a href="https://twitter.com/robsware?t=priHMGg-KwSi-uAEMpN-zw&amp;s=0">Robsware</a> for taking the time out his day to proofread this post! Bug, bother, nudge - show those two horrendously cool blokes all the love you can muster and ask them all about their expert knowledge on <code class="language-plaintext highlighter-rouge">lsass.dll</code>!</p>

<figure class="align-center" style="width: 666px">
    <img src="/assets/images/nppspy/shaggy.png" />
</figure>

<p>I’ve been absolutely <strong>brimming</strong> with excitement to release this blog post! In this hunt I covered a thorough analysis of a custom NPPSPY specimen, from loading it inside IDA Home and reproducing the attack to writing detection rules, although what was most important to me was taking on some challenges and learning a few new things along the way on and off-stream. Throughout the time you’re reading, be sure to tap or click the images to zoom in!</p>

<p>As described within the investigation post from Huntress, the original NPPSPY tool was capable of abusing the relationship between WinLogon and Local Security Authority Subsystem Service (LSASS) - when a user logins into a workstation, whether it’s domain-joined or within a workgroup, WinLogon retrieves the user’s credentials to pass on to LSASS. An attacker can write their own DLL to hand over to WinLogon using special exports and intercept these plaintext credentials to write to a file of their choice. This was once proven by <a href="https://twitter.com/0gtweet">Grzegorz Tworek</a> and later adopted by Red Canary’s Atomic Red Team framework, before eventually finding its way into a threat actor’s hands.</p>

<p>Exchange was definitely a smart place to drop the malicious DLL, which also brings the question to how catastrophic NPPSPY could be when it comes to stealing credentials from other Active Directory services. Although I’m pretty sure they can do more than writing to files, I’ll be sticking to the topic and explaining later on the adversary’s implementation from the Huntress showcase.</p>

<p>I also saw some detection methods Dray had used and thought I’d tap into my past experience within the SOC, then sprinkle in some other helpful hunting methods to the mix!</p>

<h2 id="detection-and-hunting-methods">Detection and Hunting Methods</h2>

<figure class="align-center" style="width: 549px">
    <img src="/assets/images/nppspy/professor.png" />
</figure>

<p>I may or may not have been (too) thorough, but the below would be technically most layers of detections and hunting methods to utilise if you ever handle a specimen that resembles or attempts to simulate the activity of NPPSPY. Of course, these detection methods may not be invincible as red teamers on Twitter very often demonstrate ways of evading and obfuscating their ways around them, but it would still catch your average script kiddie and lazy malware authors! Honestly, I’d say the Windows registry would be the easiest detection method, as there should be no reason it should change. If there’s not a ticket, then it is a crime! But without further ado, I will now take a deep dive into the detections! A fair amount of credit also goes to <a href="https://twitter.com/snapattackHQ">SnapAttackHQ</a> for their <a href="https://www.youtube.com/watch?v=XbdN8z0Rxic">video</a> also covering detection methods for NPPSPY, go check them out!</p>

<p>MITRE Techniques: <a href="https://attack.mitre.org/techniques/T1003/">T1003 - OS Credential Dumping</a> and <a href="https://attack.mitre.org/techniques/T1556/002/">T1556.002 - Modify Authentication Process: Password Filter DLL</a>.</p>

<ul>
  <li>
    <p><strong>PowerShell Script Block Logging</strong> (event code <code class="language-plaintext highlighter-rouge">4104</code>, practically my favourite one to hunt)</p>
  </li>
  <li>
    <p><strong>Process creation</strong>: <code class="language-plaintext highlighter-rouge">copy.exe</code>, <code class="language-plaintext highlighter-rouge">powershell</code> or <code class="language-plaintext highlighter-rouge">reg.exe</code>. These would be less likely to be written as detection rules, and more for hunting purposes to build a timeline of how the attacker carried out an attack to achieve their objectives.</p>
  </li>
  <li>
    <p><strong>File creation</strong> at <code class="language-plaintext highlighter-rouge">C:\Windows\System32\</code> by an administrator account without any proof of legitimacy. There is a possibility that this can be easily slipped under the hood by impersonating the <code class="language-plaintext highlighter-rouge">SYSTEM</code> account. The source file was a PE, but seeing from the ways malware authors have been <strong>wilding</strong> with DLL names, the file extension can be trivial. Naming it wrongly can still make it stand out like a sore thumb and make a lot easier to detect the bad doing in your environment!</p>
  </li>
</ul>

<figure class=" ">
  
  
</figure>

<figure class="align-center" style="width: 400px">
    <img src="/assets/images/nppspy/spy.png" />
        <figcaption>A real and true executable</figcaption>
</figure>

<ul>
  <li><strong>Registry modifications and creation</strong> of the following (event IDs <code class="language-plaintext highlighter-rouge">12</code>, <code class="language-plaintext highlighter-rouge">13</code> and <code class="language-plaintext highlighter-rouge">4657</code>):
    <ul>
      <li><code class="language-plaintext highlighter-rouge">HLKM\SYSTEM\CurrentControlSet\Control\NetworkProvider\Order</code></li>
      <li><code class="language-plaintext highlighter-rouge">HLKM\SYSTEM\CurrentControlSet\Services\&lt;Arbitrary Value&gt;</code></li>
      <li><code class="language-plaintext highlighter-rouge">HLKM\SYSTEM\CurrentControlSet\Services\&lt;Arbitrary Value&gt;\NetworkProvider</code></li>
      <li><code class="language-plaintext highlighter-rouge">HLKM\SYSTEM\CurrentControlSet\Services\&lt;Arbitrary Value&gt;\NetworkProvider\Class</code></li>
      <li><code class="language-plaintext highlighter-rouge">HLKM\SYSTEM\CurrentControlSet\Services\&lt;Arbitrary Value&gt;\NetworkProvider\Name</code></li>
      <li><code class="language-plaintext highlighter-rouge">HLKM\SYSTEM\CurrentControlSet\Services\&lt;Arbitrary Value&gt;\NetworkProvider\ProviderPath</code></li>
    </ul>
  </li>
  <li>In terms of malware research and EDRs, I’d assume hooking the following APIs:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">CreateFile</code> and <code class="language-plaintext highlighter-rouge">WriteFile</code> for file operations</li>
      <li><code class="language-plaintext highlighter-rouge">RegOpenKey</code> or <code class="language-plaintext highlighter-rouge">RegCreateKey</code> followed by <code class="language-plaintext highlighter-rouge">RegSetValue</code> or <code class="language-plaintext highlighter-rouge">RegQueryValue</code>.</li>
    </ul>
  </li>
  <li><strong>File creation</strong> from the <code class="language-plaintext highlighter-rouge">mpnotify.exe</code> image (event ID <code class="language-plaintext highlighter-rouge">11</code>) - within the next section, I will explain why!</li>
</ul>

<h2 id="lsassdll-static--dynamic-analysis">‘lsass.dll’ Static &amp; Dynamic Analysis</h2>
<p>We will focus on two important functions: <code class="language-plaintext highlighter-rouge">NPGetCaps</code> and <code class="language-plaintext highlighter-rouge">NPLogonNotify</code>.</p>

<p><code class="language-plaintext highlighter-rouge">NPGetCaps</code> returns values that are relevant to information on which services are supported on the network. This is mostly to resemble somewhat “legitimate” behaviour from a service DLL, and therefore loses its spotlight in the analysis!</p>

<figure class="align-center" style="width: 311px">
    <img src="/assets/images/nppspy/npgetcaps.png" alt="An absurdly benign and boring function presented by the NPGetCaps export!" />
    <figcaption>An absurdly benign and boring function presented by the NPGetCaps export!</figcaption>
</figure>

<h3 id="nplogonnotify">NPLogonNotify</h3>
<p><a href="https://learn.microsoft.com/en-us/windows/win32/api/npapi/nf-npapi-nplogonnotify"><code class="language-plaintext highlighter-rouge">NPLogonNotify</code></a> calls <code class="language-plaintext highlighter-rouge">SavePassword</code>, therefore the meat of the malware is at <code class="language-plaintext highlighter-rouge">0x180001000</code>.</p>

<figure class=" ">
  
    
      <a href="/assets/images/nppspy/nplogonnotify.png">
          <img src="/assets/images/nppspy/nplogonnotify.png" alt="" />
      </a>
    
  
  
</figure>

<p>As seen in the below images, the adversary tried to obfuscate the malicious function with stack strings, which stored an encrypted file path that was later on decrypted for malicious DLL to write the stolen credentials to. While having the original NPPSpy code from GitHub made this obvious, this trick can still be useful in obfuscating the file in ways we do not expect and temporarily evading endpoint protection!</p>

<figure class="half ">
  
    
      <a href="/assets/images/nppspy/stackstrings.png" title="Greeted by a bunch of stack strings - very small compared to malware campaigns like Emotet!">
          <img src="/assets/images/nppspy/stackstrings.png" alt="Greeted by a bunch of stack strings - very small compared to malware campaigns like Emotet!" />
      </a>
    
  
    
      <a href="/assets/images/nppspy/decryption-routine.png" title="Decryption loop at the end of the stack strings">
          <img src="/assets/images/nppspy/decryption-routine.png" alt="Decryption loop at the end of the stack strings" />
      </a>
    
  
  
    <figcaption>Disassembly as shown by IDA. Tap them for a better view!
</figcaption>
  
</figure>

<p>When I initially loaded and decompiled the function within IDA, the psuedocode was heavily optimised so I needed to reconstruct the string at stack level. In all honesty, I spent the longest time of the analysis on this because I wasn’t aware that stack strings can appear differently than intended because of the way a decompiler translates from Assembly to psuedocode, but it was still a great learning experience and a powerful reminder that no tool is perfect and will almost always require intervention from its user.</p>

<figure class=" ">
  
    
      <a href="/assets/images/nppspy/stackstrings-before-vs-after.png" title="Before vs after cleaning up the psuedocode with labelling">
          <img src="/assets/images/nppspy/stackstrings-before-vs-after.png" alt="" />
      </a>
    
  
  
</figure>

<p>After reconstructing the stack string and using Python to replicate the decryption routine, it was revealed that the stack string eventually resolved to <code class="language-plaintext highlighter-rouge">C:\\ProgramData\\Package Cache\\Windows10.0-KB5009543-x64.msu</code>. This demonstrates that the attacker had tried to masquerade the dropped file as a standalone Windows Update file, which can be very tricky for a defender to spot!</p>

<p>With this theory in mind, I performed some dynamic analysis to prove the suspected behaviour.</p>

<figure class="align-center" style="width: 856px">
    <img src="/assets/images/nppspy/oneliner.png" />
    <figcaption>PowerShell commands written across as a messy one-liner to replicate the attack scenario</figcaption>
</figure>

<figure class="align-center" style="width: 887px">
    <img src="/assets/images/nppspy/dropped-credentials.png" />
    <figcaption>The world's strongest password revealed and written over to `Windows10.0-KB5009543-x64.msu</figcaption>
</figure>

<p>Since the file was dropped on disk, I believed it would be impossible to not be able to detect it through Sysmon, so I decided test some custom rules. Adding the below detection rule to the Sysmon config file from <a href="https://github.com/SwiftOnSecurity/sysmon-config/">SwiftOnSecurity</a>, it was revealed that <code class="language-plaintext highlighter-rouge">mpconfig.exe</code> would be responsible for the file creation activity:</p>

<p><code class="language-plaintext highlighter-rouge">&lt;TargetFilename name="OSCredentialDumping" condition="end with"&gt;Windows10.0-KB5009543-x64.msu&lt;/TargetFilename&gt; &lt;!--File created from lsass.dll/NPPSpy--&gt;</code></p>

<figure class="align-center" style="width: 900px">
    <img src="/assets/images/nppspy/sysmon.png" />
    <figcaption>mpnotify.exe shown to create files from the detection rules</figcaption>
</figure>

<p><code class="language-plaintext highlighter-rouge">mpnotify.exe</code> has not been known to create or write any files as shown by this <a href="https://strontic.github.io/xcyclopedia/library/mpnotify.exe-8F9739E266623499391CBAC652A01036.html">post</a>. I suspect that attackers may find more use for it than just theft of passwords though. For example, they can force an implant to run on another thread or simply open a HTTP connection to send credentials back to a C2 server - the possibilities are endless! Again, this requires administrator privileges and will be quite noisy.</p>

<h2 id="yara-time">YARA Time</h2>
<p>After performing the static and dynamic analysis on the DLL, I thought it was about time I demonstrated how I would use <a href="https://twitter.com/cyb3rops">Florian Roth</a>’s excellent tool, YARA!</p>

<p>In my eCTHPv2 review post, I talked about how YARA and other forms of detection rules can only be as great as the people that wrote them. For anyone else who’s learning, allow me to walk you through a few steps I’d go!</p>

<p>When creating YARA rules, you’d target the most critical malicious functions (TTPs), followed by hardcoded strings that appear to be written by a human. If possible, you would also conduct a comparative analysis to search for reused code, which the <a href="https://www.zynamics.com/bindiff.html"><code class="language-plaintext highlighter-rouge">BinDiff</code></a> tool can be very helpful for. In order to achieve a goal, an adversary tends to exhibit certain behaviours regardless of their tools, though some differ a lot more than others when being heavily OPSEC-focused. However, by targeting the TTPs, you’re essentially ruling based on the behaviour of a malware specimen, and causing a threat actor to put more effort into obfuscating their activity or entirely switch tools altogether. It then becomes a cyclic arms race - with the threat actor rewriting or hiding their tools and you revising and evolving your detection rules! Although it may not be as easy as it sounds, once you get used to analysing malware across different campaigns, you would then begin to notice certain patterns, profile threat actors and even spot when they introduce some new quirks and ‘updates’ into their bad doing!</p>

<p>In the case of malware research, this meant retrieving opcodes for certain operations such as encryption algorithms, file &amp; registry operations - basically anything that would be require a lot of effort to obfuscate. The main things I focused on were the stack strings as well as the common exports and algorithms and across both samples, plus any extras like decrypted strings to make them adapted for certain hunts whether on VirusTotal or through Volatility’s in-memory <code class="language-plaintext highlighter-rouge">yarascan</code> module. There may be a chance you’d capture payloads and useful strings while they are decrypted in memory! The below YARA rule draft reflects the observations I made on both the original and custom NPPSPY DLLs:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import "pe"

rule nppspy_or_variants
{
    meta:
        name = "NPPSpy and Variants"
        description = "Malware Hunt - The Curious Case of MPNotify &amp; NPPSPY"
        techniques = "T1003, T1556.002"
        weaponisation = "Masquarades as lsass.dll, and then extracts the credentials from WinLogon by getting sideloaded within MpNotify to dump into a file."
        reference = "https://www.huntress.com/blog/cleartext-shenanigans-gifting-user-passwords-to-adversaries-with-nppspy"
        report = "https://www.malwareguy.tech/Hunts/nppspy.html"
        author = "Malware Guy"
        version = "1.1"
        hash1 = "e30f8596f1beda8254cbe1ac7a75839f5fe6c332f45ebabff88aadbce3938a19"
        hash2 = "b283415c9df06f0e53b7d452d3e5c840c5bd7a6ce734a30bae4a869a57974a0e"
    
    strings:
        $s1 = "C:\\NPPSpy.txt" wide
        $s2 = "NPPSPY.dll" fullword ascii
        $s3 = "C:\\ProgramData\\Package Cache\\Windows10.0-KB5009543-x64.msu" // Added for redundancy
        $opcodes1 = { C6 84 24 ?? ?? 00 00 ?? } // Stack Strings
        $opcodes2 = { C6 44 24 ?? ?? } // Stack Strings
        $opcodes3 = { 48 63 44 24 40 48 83 F8 ?? } // Set up the path to decrypt - beginning
        $opcodes4 = { 48 63 44 24 40 0F BE 44 04 78 89 44 24 50 48 63 4C 24 40 33 D2 48 8B C1 B9 20 00 00 00 48 F7 F1 48 8B C2 0F BE 44 04 58 8B 4C 24 50 33 C8 8B C1 48 63 4C 24 40 88 84 0C 58 01 00 00 E9 46 FC FF FF } // String Decryption Routine
        $opcodes5 = { 8B 44 24 40 FF C0 89 44 24 40 48 63 44 24 40 } // Increment index and repeat loop

        condition:
            ((uint16(0) == 0x5A4D) and (uint32(uint32(0x3C)) == 0x00004550)) and (pe.exports("NpGetCaps") and pe.exports("NpLogonNotify")) and ((pe.imports("kernel32.dll", "CreateFileA") or pe.imports("kernel32.dll", "CreateFileW")) and (pe.imports("kernel32.dll", "WriteFile") and pe.imports("kernel32.dll", "SetFilePointer"))) and (((2 of ($s*)) and pe.pdb_path == "C:\\Users\\GrzegorzTworek\\source\\repos\\NPPSpy\\x64\\Release\\NPPSPY.pdb") or (2 of ($opcodes*)))
}
</code></pre></div></div>

<p>After a great amount of trial and error, the YARA rules eventually alerted on both specimen!</p>

<figure class="align-center" style="width: 860px">
    <img src="/assets/images/nppspy/yaratest.png" />
</figure>

<figure class="align-center" style="width: 596px">
    <img src="/assets/images/nppspy/stonks.jpeg" />
</figure>

<h2 id="mitigations">Mitigations</h2>
<p>EDIT: On Twitter, Grzegorz Tworek himself offered a mitigation method which prevents the attack from being successful:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">If you are responsible for Win11 security baseline, please use the new (I mean fixed after 20+ years) configuration option &quot;Enable MPR notifications&quot; under Windows Components\Windows Logon Options.<br />Defaults allow to read cleartext credentials from Winlogon with a simple DLL. <a href="https://t.co/pUBWQCNkeI">pic.twitter.com/pUBWQCNkeI</a></p>&mdash; Grzegorz Tworek (@0gtweet) <a href="https://twitter.com/0gtweet/status/1610914693912166400?ref_src=twsrc%5Etfw">January 5, 2023</a></blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h2 id="final-thoughts">Final Thoughts</h2>
<p>Thank you for reading my post! I’ve learned quite a bit from hunting this specimen, and as usual, only ever plan on doing even more. Because of a few select individuals within the Infosec community, I am now slightly more knowledgeable about how Windows environments (dangerously) handle authentication, and have my own input to give you guys within the community something to read.</p>

<p>I consider the YARA rule I’ve written in this post to be a draft, and there may be another version of it depending on if criminal hackers adopted this technique a lot more (very unlikely, hopefully) and I looked at this malware family again. Either way, having stronger and layered detection rules increases your confidence that you (or your AI) will have a better chance of catching certain malware once it makes its way into your environment! I also had a Sigma hunting and IOC rule related to the malicious activity published on SOC Prime, if you would like to give it a test run, check it out <a href="https://tdm.socprime.com/tdm/info/n8oCdFvnALY7/?p=1">here</a>. You will need an account to access it!</p>

<p>If you would like to learn a few helpful malware research techniques and have some experience with IDA already, I’d definitely recommend the <a href="https://courses.zero2auto.com">Zero2Automated</a> course! If you also happen to have any feedback about my post or have suggestions on what I could work on, you’re more than welcome to reach out to me on any of my handles! I also stream, so if you’re down for a chat whenever I’m live then just drop by anytime.</p>

<figure class=" ">
  
    
      <a href="/assets/images/nppspy/vegito.gif">
          <img src="/assets/images/nppspy/vegito.gif" alt="" />
      </a>
    
  
  
</figure>

<h2 id="references">References</h2>
<p><strong>lsass.dll:</strong>
SHA256: <code class="language-plaintext highlighter-rouge">E30F8596F1BEDA8254CBE1AC7A75839F5FE6C332F45EBABFF88AADBCE3938A19</code></p>

<p><a href="https://www.virustotal.com/gui/file/e30f8596f1beda8254cbe1ac7a75839f5fe6c332f45ebabff88aadbce3938a19/">https://www.virustotal.com/gui/file/e30f8596f1beda8254cbe1ac7a75839f5fe6c332f45ebabff88aadbce3938a19/</a>
<a href="https://analyze.intezer.com/analyses/ea11eeb9-d345-46e3-a1cb-2ce47f933ee0">https://analyze.intezer.com/analyses/ea11eeb9-d345-46e3-a1cb-2ce47f933ee0</a></p>

<p><strong>Atomic Red Team:</strong>
<a href="https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1003/T1003.md#atomic-test-2---credential-dumping-with-nppspy">https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1003/T1003.md#atomic-test-2—credential-dumping-with-nppspy</a></p>

<p><strong>Original PoC:</strong>
SHA256: <code class="language-plaintext highlighter-rouge">B283415C9DF06F0E53B7D452D3E5C840C5BD7A6CE734A30BAE4A869A57974A0E</code>
<a href="https://github.com/gtworek/PSBits/blob/master/PasswordStealing/NPPSpy/NPPSPY.dll">https://github.com/gtworek/PSBits/blob/master/PasswordStealing/NPPSpy/NPPSPY.dll</a>
<a href="https://analyze.intezer.com/analyses/7d8a7434-258e-4e87-a1c7-e832485a51b4">https://analyze.intezer.com/analyses/7d8a7434-258e-4e87-a1c7-e832485a51b4</a></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#capa-explorer" class="page__taxonomy-item p-category" rel="tag">CAPA Explorer</a><span class="sep">, </span>
    
      <a href="/tags/#ida" class="page__taxonomy-item p-category" rel="tag">IDA</a><span class="sep">, </span>
    
      <a href="/tags/#nppspy" class="page__taxonomy-item p-category" rel="tag">NPPSpy</a><span class="sep">, </span>
    
      <a href="/tags/#sigma" class="page__taxonomy-item p-category" rel="tag">Sigma</a><span class="sep">, </span>
    
      <a href="/tags/#sysmon" class="page__taxonomy-item p-category" rel="tag">Sysmon</a><span class="sep">, </span>
    
      <a href="/tags/#yara" class="page__taxonomy-item p-category" rel="tag">YARA</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#hunts" class="page__taxonomy-item p-category" rel="tag">Hunts</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2023-01-20T00:00:00+00:00">January 20, 2023</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=The+Curious+Case+of+MPNotify+%26+NPPSPY%20http%3A%2F%2Flocalhost%3A4000%2FHunts%2Fnppspy.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2FHunts%2Fnppspy.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2FHunts%2Fnppspy.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/RE-notes/patching.html" class="pagination--pager" title="Patching
">Previous</a>
    
    
      <a href="/RE-Notes/pointers.html" class="pagination--pager" title="Pointers (&amp;memes explained)
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You may also enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/forgor.jpeg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/RE-Notes/pointers.html" rel="permalink">Pointers (&amp;memes explained)
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">This RE shitpost note was not sponsored by the OALabs Patreon, however if you don’t have it already go and check their awesome content out. I would also like...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/RE-notes/patching.html" rel="permalink">Patching
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          9 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I wrote this post as I thought it would be fun to explore some reverse engineering techniques — in (almost) simplified terms! Typically, patching can be used...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/Course-Reviews/eCTHPv2.html" rel="permalink">My eCTHPv2 Experiences
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I taken eCTHPv2 back in April, and eventually decided I wanted to write my personal thoughts and overall experience around the course!

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/Hunts/redline-stealer.html" rel="permalink">Redline Stealer
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          13 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Intro
For this hunt, I will be sharing my analysis notes and thought processes on how I approached the Redline Stealer malware, what I learned from reverse e...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://www.twitch.tv/malware_guy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitch" aria-hidden="true"></i> Twitch</a></li>
        
      
        
          <li><a href="https://twitter.com/themalwareguy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/MalwareGuy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.youtube.com/channel/UCKLRrI3yzes4p8GpWAdwevg" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-youtube" aria-hidden="true"></i> YouTube</a></li>
        
      
        
          <li><a href="https://discord.gg/kvU3kvt4Qb" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-discord" aria-hidden="true"></i> Discord</a></li>
        
      
        
          <li><a href="https://www.instagram.com/malware_guy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram</a></li>
        
      
        
          <li><a href="https://infosec.exchange/@malware_guy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i> Mastodon</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Malware Guy. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>. PS: If you knowingly stumble upon any malware from my hunts and end up downloading it and infecting yourself, I will point and laugh at you. I hold no liability over the cat's curiosity if it gets the better of them!</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
