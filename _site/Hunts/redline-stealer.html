<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Redline Stealer - Malware Guy</title>
<meta name="description" content="For this hunt, I will be sharing my analysis notes and thought processes on how I approached the Redline Stealer malware…">


  <meta name="author" content="Malware Guy">
  
  <meta property="article:author" content="Malware Guy">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="Malware Guy">
<meta property="og:title" content="Redline Stealer">
<meta property="og:url" content="http://localhost:4000/Hunts/redline-stealer.html">


  <meta property="og:description" content="For this hunt, I will be sharing my analysis notes and thought processes on how I approached the Redline Stealer malware…">



  <meta property="og:image" content="http://localhost:4000/assets/images/banner.png">





  <meta property="article:published_time" content="2022-09-09T00:00:00+01:00">





  

  


<link rel="canonical" href="http://localhost:4000/Hunts/redline-stealer.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Malware Guy",
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Malware Guy Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Malware Guy
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/posts/">Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero"
  style=" background-image: url('');"
>
  
    <img src="/assets/images/banner.png" alt="Redline Stealer" class="page__hero-image">
  
  
</div>







<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="http://localhost:4000/">
        <img src="/assets/images/PNGTuber_Malware_Talk.png" alt="Malware Guy" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="http://localhost:4000/" itemprop="url">Malware Guy</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Malware Hunting VTuber</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      
        
          
            <li><a href="https://www.twitch.tv/malware_guy" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-twitch" aria-hidden="true"></i><span class="label">Twitch</span></a></li>
          
        
          
            <li><a href="https://twitter.com/themalwareguy" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/MalwareGuy" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.youtube.com/channel/UCKLRrI3yzes4p8GpWAdwevg" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-youtube" aria-hidden="true"></i><span class="label">YouTube</span></a></li>
          
        
          
            <li><a href="https://discord.gg/kvU3kvt4Qb" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-discord" aria-hidden="true"></i><span class="label">Discord</span></a></li>
          
        
          
            <li><a href="https://infosec.exchange/@malware_guy" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i><span class="label">Mastodon</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Redline Stealer">
    <meta itemprop="description" content="IntroFor this hunt, I will be sharing my analysis notes and thought processes on how I approached the Redline Stealer malware, what I learned from reverse engineering it and how it given me an idea of what I can build upon the things that I currently know. Here is some background on this malware family from Malpedia:">
    <meta itemprop="datePublished" content="2022-09-09T00:00:00+01:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="http://localhost:4000/Hunts/redline-stealer.html" class="u-url" itemprop="url">Redline Stealer
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          13 minute read
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#intro">Intro</a></li><li><a href="#analysis">Analysis</a><ul><li><a href="#overlay-bytes">Overlay Bytes</a></li><li><a href="#initial-triage">Initial Triage</a></li><li><a href="#anti-debugging-dnspy">Anti-Debugging (dnSpy)</a></li><li><a href="#hunting-for-the-payload">Hunting for the payload</a></li><li><a href="#exploring-process-hollowing">Exploring Process Hollowing</a><ul><li><a href="#createprocessw">CreateProcessW</a></li><li><a href="#createprocessa">CreateProcessA</a></li><li><a href="#writeprocessmemory">WriteProcessMemory</a></li></ul></li><li><a href="#dumping-the-injected-pe">Dumping the injected PE</a><ul><li><a href="#wsaconnect">WSAConnect</a></li></ul></li><li><a href="#iocs">IOCs</a></li><li><a href="#references">References</a></li></ul></li><li><a href="#vmprotected-variant">VMProtected Variant</a><ul><li><a href="#initial-triage-1">Initial Triage</a></li><li><a href="#assumptions-for-future-analysis">Assumptions for Future Analysis</a></li></ul></li><li><a href="#threat-intelligence">Threat Intelligence</a></li><li><a href="#ending-thoughts">Ending Thoughts</a></li><li><a href="#shoutouts">Shoutouts</a></li></ul>

            </nav>
          </aside>
        
        <h2 id="intro">Intro</h2>
<p><strong>For this hunt, I will be sharing my analysis notes and thought processes on how I approached the Redline Stealer malware, what I learned from reverse engineering it and how it given me an idea of what I can build upon the things that I currently know.</strong> Here is some background on this malware family from Malpedia:</p>

<p><em>“RedLine Stealer is a malware available on underground forums for sale apparently as standalone ($100/$150 depending on the version) or also on a subscription basis ($100/month). This malware harvests information from browsers such as saved credentials, autocomplete data, and credit card information. A system inventory is also taken when running on a target machine, to include details such as the username, location data, hardware configuration, and information regarding installed security software. More recent versions of RedLine added the ability to steal cryptocurrency. FTP and IM clients are also apparently targeted by this family, and this malware has the ability to upload and download files, execute commands, and periodically send back information about the infected computer.”</em></p>

<p>Recently, many content creators had been targeted by this particular malware campaign, abusing powerful and catastrophic yet publicly available tools (ahem, YouTube’s Copyright Claims system) to conduct cunning yet startlingly convincing attacks. I wanted to gain an understanding of the mechanics behind these attacks better through slightly lower level tools (as well as a great amount of improvising and frustration!) and techniques that can be used to handle crimeware.</p>

<p>To start with the hunt, here were the tools I used:</p>
<ul>
  <li>Detect It Easy</li>
  <li>CAPA 4</li>
  <li>dnSpy</li>
  <li>Process Hacker</li>
  <li>x64dbg</li>
  <li>PE Sieve</li>
</ul>

<h2 id="analysis">Analysis</h2>
<h3 id="overlay-bytes">Overlay Bytes</h3>
<p>To evade sandboxes and antimalware, the original file contained an overlay, which caused it to be too big to analyse inside automated environments (<a href="https://reverseengineering.stackexchange.com/a/2015">reference</a>).</p>

<figure class="">
  <img src="/assets/images/Redline/20220823191213.png" alt="" /><figcaption>
      The sample totals to 700MB, which can evade set file size limits within sandboxes and antimalware solutions

    </figcaption></figure>

<p>Within Detect It Easy, the PE is shown to have its normal sections, as well as the bytes that prevent it from being analysed.</p>

<figure class="">
  <img src="/assets/images/Redline/20220823190601.png" alt="" /><figcaption>
      Rows of bytes consisting of 0x30 (0 in ASCII) lay dormant within the executable

    </figcaption></figure>

<p>The below script can be used to strip the overlay bytes from the executable to bring it back close to its original size.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pefile</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">filename</span> <span class="o">=</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[*] Original file size: </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"[*] Stripping overlay from file, standby..."</span><span class="p">)</span>

<span class="n">pe</span> <span class="o">=</span> <span class="n">pefile</span><span class="p">.</span><span class="n">PE</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">overlay</span> <span class="o">=</span> <span class="n">pe</span><span class="p">.</span><span class="n">get_overlay_data_start_offset</span><span class="p">()</span>

<span class="n">strip_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">".strip"</span> 

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">overlay</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">strip_filename</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[*] Stripped file size: </span><span class="si">{</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">strip_filename</span><span class="p">)</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[*] New file is called </span><span class="si">{</span><span class="n">strip_filename</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"[+] Done!"</span><span class="p">)</span>
</code></pre></div></div>

<p>Alternatively, de4dot is capable of guessing the type of obfuscator used by the malware authors and removing the overlay, which I went with.</p>

<figure class="">
  <img src="/assets/images/Redline/20220827211430.png" alt="" /><figcaption>
      de4dot identified a possible obfuscator used and cleaned the overlay bytes as well as light obfuscation

    </figcaption></figure>

<h3 id="initial-triage">Initial Triage</h3>
<p>Searching through VirusTotal, there were no community comments at the time of investigation despite the sample having been uploaded there for a while. It was only known to be malicious by several AV engines.</p>

<figure class="">
  <img src="/assets/images/Redline/20220823175315.png" alt="" /><figcaption>
      Vendor results from VirusTotal

    </figcaption></figure>

<p>Intezer however, was a different story. When running the sample inside its sandbox, it reported the following TTPs:</p>
<ul>
  <li>Code Injection - Process Hollowing</li>
  <li>Trusted Developer Utilities Proxy Execution - <code class="language-plaintext highlighter-rouge">InstallUtil</code> (<a href="https://docs.microsoft.com/en-us/dotnet/framework/tools/installutil-exe-installer-tool">https://docs.microsoft.com/en-us/dotnet/framework/tools/installutil-exe-installer-tool</a>)</li>
  <li>An attempted connection to <code class="language-plaintext highlighter-rouge">65[.]21[.]74[.]139</code> (inactive at the time of the investigation) via a non-standard port</li>
  <li>Launches PowerShell with an encoded command</li>
</ul>

<figure class="">
  <img src="/assets/images/Redline/20220823185117.png" alt="" /><figcaption>
      TTPs as well as their techniques, severity ratings and further details were identified in Intezer

    </figcaption></figure>

<p>As expected, all platforms also reported that the implant steals credentials. At this point, it was time to investigate within dnSpy.</p>

<h3 id="anti-debugging-dnspy">Anti-Debugging (dnSpy)</h3>
<p>After loading the sample into dnSpy, I found that its classes and objects had very deceptive names (surprise, surprise in crimeware). After attempting to run it, the sample halted its execution due to the presence of the debugger.</p>

<figure class="">
  <img src="/assets/images/Redline/20220823233012.png" alt="" /><figcaption>
      An anti-debugging technique was used to slow down dynamic analysis

    </figcaption></figure>

<p>This Redline sample detected dnSpy through dynamically imported functions, and to deal with this, I patched the IL assembly instruction for the line of <code class="language-plaintext highlighter-rouge">if (ImageInvoker.DisableReference())</code> - the new logic of the expression was that if the sample detects the debugger, it runs. Reverse <del>engineering</del> psychology, right?</p>

<figure class="">
  <img src="/assets/images/Redline/20220824193908.png" alt="" /><figcaption>
      The original logic of the expression within the IL instructions was <code class="language-plaintext highlighter-rouge">bfalse.s</code>, before it got reversed to <code class="language-plaintext highlighter-rouge">btrue.s</code> through patching

    </figcaption></figure>

<p>After saving the module, the implant worked perfectly.</p>

<h3 id="hunting-for-the-payload">Hunting for the payload</h3>
<p>After scouting through the executable, I found an abnormally long series of bytes which even dnSpy couldn’t process them all.</p>

<figure class="">
  <img src="/assets/images/Redline/20220828141801.png" alt="" /><figcaption>
      Noticing an array of bytes present within the C#

    </figcaption></figure>

<figure class="">
  <img src="/assets/images/Redline/20220828141830.png" alt="" /><figcaption>
      …10000+ lines later

    </figcaption></figure>

<p>It was like staring down an elephant inside the room! I set a breakpoint at the caller so I can extract it from memory. It was 509KB in total.</p>

<figure class="">
  <img src="/assets/images/Redline/20220828140940.png" alt="" /><figcaption>
      Chucking a Pokéball at the payload in memory

    </figcaption></figure>

<p>After decompressing the gzip data with CyberChef, the payload was found to be indeed a .NET-based PE. However, it was heavily obfuscated. de4dot was unable to detect which obfuscator was used on it as well.</p>

<figure class="">
  <img src="/assets/images/Redline/20220828142211.png" alt="" /><figcaption>
      .NET assembly found in memory, containing obfuscated namespaces, classes and methods

    </figcaption></figure>

<h3 id="exploring-process-hollowing">Exploring Process Hollowing</h3>
<figure class="">
  <img src="/assets/images/Redline/6sru1r.jpg" alt="" /><figcaption>
      Definitely not a generated meme

    </figcaption></figure>

<p><strong>I wanted to explore process hollowing as it happened at code level</strong>, but given that the code of the payload was heavily obfuscated, viewing the unmanaged calls through dnSpy proven difficult.</p>

<p>Some of my wild guesses were:</p>
<ul>
  <li>.NET and PowerShell abuse <code class="language-plaintext highlighter-rouge">System.Reflection.Assembly.Load</code> - the process hollowing may have been happening through the invoked .NET assembly, so it may bave been best to set a breakpoint at this function and extract .NET assemblies from there. The <code class="language-plaintext highlighter-rouge">ImageDictionary</code> class was likely responsible for this.</li>
</ul>

<p>I noticed that the sample killed its own process prior to starting <code class="language-plaintext highlighter-rouge">InstallUtil</code>. I set a breakpoint at various functions I believed the malware used (including <code class="language-plaintext highlighter-rouge">Process.WaitForExit</code>), and after a bit (hours, actually) of stepping through the code inside the debugger and observing the call stack, here was an example of what I seen:</p>

<figure class="">
  <img src="/assets/images/Redline/20220828123648.png" alt="" /><figcaption>
      Call stack of the functions called before <code class="language-plaintext highlighter-rouge">Process.WaitForExit</code>

    </figcaption></figure>

<p>Quite the mess! Trying to analyse the obfuscated .NET assembly in dnSpy was a difficult task, so in the end I opted for continuing the dynamic analysis through x64dbg as the executable will eventually remove its own obfuscation once it is fully loaded in memory.</p>

<p>I’m aware that process hollowing uses the following APIs, which I set breakpoints for (as well as their counterparts) inside x64dbg, the ones in bold being prioritised due to them containing arguments related to what was seen in the TTPs:</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">CreateProcess</code></strong></li>
  <li><code class="language-plaintext highlighter-rouge">ZwUnmapViewOfSection</code></li>
  <li><code class="language-plaintext highlighter-rouge">VirtualAllocEx</code></li>
  <li><strong><code class="language-plaintext highlighter-rouge">WriteProcessMemory</code></strong></li>
  <li><code class="language-plaintext highlighter-rouge">SetThreadContext</code></li>
  <li><code class="language-plaintext highlighter-rouge">ResumeThread</code></li>
</ul>

<p>This is a classic pattern of process hollowing to make room for the malicious process, launching a legitimate Windows executable and using it as a sacrifical lamb to hide from security tools that lack the capability to detect and prevent malicious usage of these APIs. In the below sections. I was able to catch a few calls to a number of calls on some breakpoints.</p>

<h4 id="createprocessw">CreateProcessW</h4>
<p>After a lot of trial and error, the first breakpoint that caught my eye was a call to <code class="language-plaintext highlighter-rouge">CreateProcessW</code>.</p>

<figure class="">
  <img src="/assets/images/Redline/20220905185146.png" alt="" /><figcaption>
      First call made to <code class="language-plaintext highlighter-rouge">CreateProcessW</code>

    </figcaption></figure>

<p>One of its arguments within the stack aimed to execute 64-bit PowerShell, along with a Base64-encoded command that causes the console to sleep for 10 seconds. Unimportant, but still one of the TTPs and a way to identify similar behaviour.</p>

<figure class="">
  <img src="/assets/images/Redline/20220905185218.png" alt="" /><figcaption>
      As seen in the stack

    </figcaption></figure>

<p>The full command line can be as seen in Process Hacker:</p>

<figure class="">
  <img src="/assets/images/Redline/20220905185540.png" alt="" /></figure>

<h4 id="createprocessa">CreateProcessA</h4>
<p>As expected, the malware eventually made a call to <code class="language-plaintext highlighter-rouge">CreateProcessA</code> that requested the Windows API to start a suspended process with the image of <code class="language-plaintext highlighter-rouge">InstallUtil</code>. <code class="language-plaintext highlighter-rouge">ZwUnmapViewOfSection</code> and <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> calls targeting <code class="language-plaintext highlighter-rouge">InstallUtil</code> followed not long after, removing all executable instructions of the original PE image and allocating space for the payload to be injected.</p>

<figure class="">
  <img src="/assets/images/Redline/20220905180455.png" alt="" /><figcaption>
      First breakpoint at <code class="language-plaintext highlighter-rouge">CreateProcessA</code>

    </figcaption></figure>

<figure class="">
  <img src="/assets/images/Redline/20220905180702.png" alt="" /><figcaption>
      Command line presented to the function

    </figcaption></figure>

<p>Below shows the strings of the original executable in memory before the injection and the parent-child relationship between the processes:</p>

<figure class="">
  <img src="/assets/images/Redline/20220905180824.png" alt="" /><figcaption>
      Normal strings expected within the executable

    </figcaption></figure>

<figure class="">
  <img src="/assets/images/Redline/20220905180848.png" alt="" /><figcaption>
      The sample presented itself as the parent process for <code class="language-plaintext highlighter-rouge">InstallUtil</code> - this can be helpful when hunting for IOCs through SIEMs

    </figcaption></figure>

<h4 id="writeprocessmemory">WriteProcessMemory</h4>
<p>Finally, it was the Windows API call we had all been waiting for - <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code>! Being able to catch a payload as it is being written to a target (whether it’s a file, process or network destination) is a crucial part of the analysis; in this case I am simply retrieving the evidence that a write operation is taking place. Below, the API in question as well as the PE header of the payload was spotted in x64dbg.</p>

<figure class="">
  <img src="/assets/images/Redline/20220905181226.png" alt="" /><figcaption>
      <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> as well as the parameters passed to it on the stack

    </figcaption></figure>

<p>Seeing the PE header in the stack gave the impression something cool was probably happening and worth watching! I allowed the program to run the function until it had returned a couple of times and completed its transfer of data.</p>

<figure class="">
  <img src="/assets/images/Redline/20220905181217.png" alt="" /><figcaption>
      Spotting a partial chunk of the PE within the dump

    </figcaption></figure>

<p>Process Hacker also displayed corresponding results about the injection taking place within the new process.</p>

<figure class="">
  <img src="/assets/images/Redline/20220905182542.png" alt="" /><figcaption>
      Query strings, file paths and more slightly obfuscated data relating to credential stores present in memory

    </figcaption></figure>

<p>The next calls to <code class="language-plaintext highlighter-rouge">SetThreadContext</code> and <code class="language-plaintext highlighter-rouge">ResumeThread</code> would then set the entry point to the new code section and take the process out of suspended state, hence proving the proxy execution of a trusted developer utility.</p>

<p>In other targeted campaigns, I would imagine malware authors would go through a lot more effort to hide strings in memory, especially from tools such as EDRs. Several of them were found in plaintext relating to software file paths, password databases and query strings which indicates successful code injection has taken place, and the final Redline payload is now running and attempting to steal personal information.</p>

<p>Seeing those strings, it was about time to dump the payload from memory.</p>

<h3 id="dumping-the-injected-pe">Dumping the injected PE</h3>
<figure class="">
  <img src="/assets/images/Redline/online-classes-throw-away.gif" alt="" /><figcaption>
      Aggressively tossing out the malware from memory

    </figcaption></figure>

<p>Given the process hollowing technique was used to inject the payload into <code class="language-plaintext highlighter-rouge">InstallUtil</code>, I used PE Sieve to extract the malware. PE Sieve is a powerful tool for detecting processes that were targeted in a potential code injection attack, dumping replaced or injected PEs, shellcode, hooks and other in-memory patches from memory and saving them into a file readily available for analysis.</p>

<figure class="">
  <img src="/assets/images/Redline/20220905184117.png" alt="" /><figcaption>
      PE Sieve detected 1 occurrence of malicious code and dumped it into a new file

    </figcaption></figure>

<p>Of course, resulting threat intelligence tells that this executable is related to the Redline Stealer campaign due to code reuse.</p>

<figure class="">
  <img src="/assets/images/Redline/20220828203748.png" alt="" /><figcaption>
      The payload as seen in VirusTotal, it was also recognised by the signatures within Florian Roth’s tool

    </figcaption></figure>

<figure class="">
  <img src="/assets/images/Redline/20220828203841.png" alt="" /><figcaption>
      Threat intelligence as shown in Intezer

    </figcaption></figure>

<h4 id="wsaconnect">WSAConnect</h4>
<p>The payload itself was a portable executable, which could still be run alone. It was responsible for connecting to the command and control server as well as extracting and marshalling credentials and banking information to send back. Different command and control servers use a variety of protocols such as HTTP/S, DNS and IRC (ah, good old days!). Occasionally, threat actors write their own custom C2 protocols which do not adhere to the transmission rules of a well known service associated with their assigned port, and in turn can increase analysis time if it is not already known within threat intelligence, and circumvent firewall rules within organisations. In this case, the Redline sample attempted to connect back to <code class="language-plaintext highlighter-rouge">65[.]21[.]74[.]139</code> on port 20775, and for that it required the Win32 APIs.</p>

<p>MSDN described <code class="language-plaintext highlighter-rouge">WSAConnect</code> as one of the functions responsible for creating a network connection to IPv4 and IPv6 hosts. What I was most interested in was <code class="language-plaintext highlighter-rouge">name</code> - this parameter contained the address pointing to the variable that held the string of the C2 address within this malware.</p>

<figure class="">
  <img src="/assets/images/Redline/20220909004308.png" alt="" /><figcaption>
      The target here was to identify the <code class="language-plaintext highlighter-rouge">name</code> parameter, which is a <code class="language-plaintext highlighter-rouge">socketaddr</code> struct that contained the IP address of the C2 server

    </figcaption></figure>

<p>After following the stack and sequentially the DWORD for the pointer within the <code class="language-plaintext highlighter-rouge">name</code> parameter, the IP address of the command and control server was located within the memory dump.</p>

<figure class="">
  <img src="/assets/images/Redline/20220909002940.png" alt="" /><figcaption>
      The sequence of bytes containing the address pointing to the parameter I was looking for

    </figcaption></figure>

<figure class="">
  <img src="/assets/images/Redline/20220909003011.png" alt="" /><figcaption>
      The IP address of the C2 as seen in the dump

    </figcaption></figure>

<h3 id="iocs">IOCs</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Original SHA256:
b4781474596c183da5b10c22ce2260c802ef4f553ed347f4813ad30cab0d56e2

Stripped SHA256:
62B06D71CD6403A1E2DB56E498A5A8B14B6908F5DDFEC9FA4D5F49F6F4A70678

65[.]21[.]74[.]139

Process Creation - "C:\\Windows\\System32\\WindowsPowerShell\v1.0\\powershell.exe" -enc UwB0AGEAcgB0AC0AUwBsAGUAZQBwACAALQBTAGUAYwBvAG4AZABzACAAMQAwAA==

Process Creation - C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319\\InstallUtil.exe

Injected payload SHA256:
16263ec84e6175336debb2da5fda9560236b1ce00bf2eec1e2bb5714a9ce3430
</code></pre></div></div>

<h3 id="references">References</h3>
<p><a href="https://malpedia.caad.fkie.fraunhofer.de/details/win.redline_stealer">https://malpedia.caad.fkie.fraunhofer.de/details/win.redline_stealer</a>
<a href="https://tria.ge/220705-zwf3dsdaaq">https://tria.ge/220705-zwf3dsdaaq</a>
<a href="https://www.virustotal.com/gui/file/62b06d71cd6403a1e2db56e498a5a8b14b6908f5ddfec9fa4d5f49f6f4a70678">https://www.virustotal.com/gui/file/62b06d71cd6403a1e2db56e498a5a8b14b6908f5ddfec9fa4d5f49f6f4a70678</a>
<a href="https://analyze.intezer.com/analyses/6146f62d-9f78-4e38-b944-b62daa82ade7/">https://analyze.intezer.com/analyses/6146f62d-9f78-4e38-b944-b62daa82ade7/</a>
<a href="https://www.virustotal.com/gui/file/16263ec84e6175336debb2da5fda9560236b1ce00bf2eec1e2bb5714a9ce3430">https://www.virustotal.com/gui/file/16263ec84e6175336debb2da5fda9560236b1ce00bf2eec1e2bb5714a9ce3430</a>
<a href="https://analyze.intezer.com/analyses/a3ba1334-11b9-4534-934d-f17f6c501c69">https://analyze.intezer.com/analyses/a3ba1334-11b9-4534-934d-f17f6c501c69</a></p>

<h2 id="vmprotected-variant">VMProtected Variant</h2>
<p>While nearly finishing the unpacked variant, I decided to have a brief look at the one John Hammond mentioned in his <a href="https://twitter.com/_JohnHammond/status/1564271069514563586">Twitter status</a> too. As I am still learning the ropes of unpacking malware in different circumstances, I want to re-visit this on a future occasion!</p>

<h3 id="initial-triage-1">Initial Triage</h3>
<p>Pretty much the same principles applied to getting rid of the overlay. It went down from 471MB to a mere 600KB.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Original SHA256: f8df7a34f17242157f9095b4aa05740c7ea9769bacd766cb1b0eac817a52455b

Stripped SHA256: 514eef525b97f3e00ff6f4bc60955c0fe0a5ff74d5996b448e80e6eef699c5ed
</code></pre></div></div>

<figure class="">
  <img src="/assets/images/Redline/20220904130434.png" alt="" /><figcaption>
      Detect It Easy indicates the sample was packed with VMProtect 3.2-3.5 through its import hashes

    </figcaption></figure>

<figure class="">
  <img src="/assets/images/Redline/20220830194457.png" alt="" /><figcaption>
      CAPA 4 particularly didn’t enjoy being fed this sample (who would with any malware really?), probably most likely due to VMProtect 3

    </figcaption></figure>

<h3 id="assumptions-for-future-analysis">Assumptions for Future Analysis</h3>
<p>Because there is a lot of threat intelligence and analysis on Redline, many of its behaviours had been already documented and there would be a great number of assumptions to make when re-exploring this variant:</p>

<ul>
  <li>Reading files and registry keys - due to its nature of accessing password databases and files, <code class="language-plaintext highlighter-rouge">ReadFile</code> and <code class="language-plaintext highlighter-rouge">RegOpenKey</code> will be most likely used</li>
  <li>Internet Connections - it tries to connect back to C2 servers, and the connections can be emulated. Some Windows API functions for this include <code class="language-plaintext highlighter-rouge">WSAConnect</code> and <code class="language-plaintext highlighter-rouge">WSASocketW</code>.</li>
</ul>

<p>These functionalities would be enough to consider setting breakpoints at and exploring when I unpack this variant.</p>

<p>Another assumption to make is that some or many of its functions would need to be devirtualised due to it being packed by VMProtect, and if I wanted to make the executable runnable again I would need to fix the original entry point and the import address table. In the real world, there would be a high chance I would use automated tools such as UnpacMe to extract the payload, but it would be great to have some practise unpacking manually as well.</p>

<h2 id="threat-intelligence">Threat Intelligence</h2>
<p><a href="https://tria.ge/220829-ray23sbdh9">https://tria.ge/220829-ray23sbdh9</a>
<a href="https://www.virustotal.com/gui/file/514eef525b97f3e00ff6f4bc60955c0fe0a5ff74d5996b448e80e6eef699c5ed">https://www.virustotal.com/gui/file/514eef525b97f3e00ff6f4bc60955c0fe0a5ff74d5996b448e80e6eef699c5ed</a>
<a href="https://analyze.intezer.com/analyses/cd7437cf-35f9-4804-93bf-186362abd9b1">https://analyze.intezer.com/analyses/cd7437cf-35f9-4804-93bf-186362abd9b1</a>
<a href="https://www.joesandbox.com/analysis/695059/0/html">https://www.joesandbox.com/analysis/695059/0/html</a></p>

<h2 id="ending-thoughts">Ending Thoughts</h2>
<p>Investigating this sample had unearthed some skills that laid dormant in my arsenal for a very long time, and it allowed me to experiment with things that worked and did not work. I had a lot of fun working on this, going some of the extra miles with what I currently know in this hunt may not have been practical in the real world (malware reports are more focused on exposing immediate effects of malware rather than verbose steps on how to expose them) but they can come in handy on future occasions. There were a few things that I learned:</p>

<ul>
  <li>Overlays within malware - to be honest, I was surprised when I saw that this technique worked to bypass protections, but it works. Because of this flaw combined with an innocent Microsoft Office icon and convincing document title, unsuspecting victims who had been sent similar malware with no intervention from their antimalware solutions would have been impacted by this campaign</li>
  <li>Evading anti-debugging - patching the logic of this sample was exceptionally easy, especially since the malware authors did not put that much effort into preventing further analysis on it. However, that was not to say that I was unable to explore with a bit of trial and error on amending the IL instructions and source code!</li>
  <li>Understanding when to switch tools or techniques - dnSpy was definitely a good choice for static analysis on the executable before it performed code injection attacks, but made terribly for dynamic analysis especially since native APIs were outside of its scope. With x64dbg, it was possible to monitor the calls made to these APIs and see the attack happening in real time, and I would be able to save time rather than attempting to deobfuscate and understand the malware behaviour by myself!</li>
</ul>

<p>Hopefully this post was easy and comprehensive for other beginners who are also keen on getting into malware analysis. I’m looking forward to taking on more challenges!</p>

<p>Thank you for reading, if you want to talk about this post or have any questions feel free to reach out to me on any of my social media handles.</p>

<h2 id="shoutouts">Shoutouts</h2>
<p>This exercise was made possible thanks to <a href="https://twitter.com/HuskyHacksMK">HuskyHacks</a>, check his social media out!</p>

<p>Also check out <a href="https://www.twitter.com/billycontra">billycontra</a>, this awesome individual proofread my endeavors and provided some helpful advice before it went live!</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#capa" class="page__taxonomy-item p-category" rel="tag">CAPA</a><span class="sep">, </span>
    
      <a href="/tags/#detect-it-easy" class="page__taxonomy-item p-category" rel="tag">Detect It Easy</a><span class="sep">, </span>
    
      <a href="/tags/#dnspy" class="page__taxonomy-item p-category" rel="tag">dnSpy</a><span class="sep">, </span>
    
      <a href="/tags/#pe-sieve" class="page__taxonomy-item p-category" rel="tag">PE Sieve</a><span class="sep">, </span>
    
      <a href="/tags/#process-hacker" class="page__taxonomy-item p-category" rel="tag">Process Hacker</a><span class="sep">, </span>
    
      <a href="/tags/#redline-stealer" class="page__taxonomy-item p-category" rel="tag">Redline Stealer</a><span class="sep">, </span>
    
      <a href="/tags/#x64dbg" class="page__taxonomy-item p-category" rel="tag">x64dbg</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#hunts" class="page__taxonomy-item p-category" rel="tag">Hunts</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2022-09-09T00:00:00+01:00">September 9, 2022</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Redline+Stealer%20http%3A%2F%2Flocalhost%3A4000%2FHunts%2Fredline-stealer.html" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2FHunts%2Fredline-stealer.html" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2FHunts%2Fredline-stealer.html" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="#" class="pagination--pager disabled">Previous</a>
    
    
      <a href="/Course-Reviews/eCTHPv2.html" class="pagination--pager" title="My eCTHPv2 Experiences
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">You may also enjoy</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/pointers/forgor.jpeg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/RE-Notes/pointers.html" rel="permalink">Pointers (&amp;memes explained)
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">This RE shitpost note was not sponsored by the OALabs Patreon, however if you don’t have it already go and check their awesome content out. I would also like...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/nppspy/shaggy.png" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/Hunts/nppspy.html" rel="permalink">The Curious Case of MPNotify &amp; NPPSPY
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          11 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Today’s hunt was inspired from this awesome blog by Dray Agha! Also a special thanks to Robsware for taking the time out his day to proofread this post! Bug,...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/RE-notes/patching.html" rel="permalink">Patching
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          9 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I wrote this post as I thought it would be fun to explore some reverse engineering techniques — in (almost) simplified terms! Typically, patching can be used...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/ecthpv2/ecthpv2_logo.png" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/Course-Reviews/eCTHPv2.html" rel="permalink">My eCTHPv2 Experiences
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">I taken eCTHPv2 back in April, and eventually decided I wanted to write my personal thoughts and overall experience around the course!

</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://www.twitch.tv/malware_guy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitch" aria-hidden="true"></i> Twitch</a></li>
        
      
        
          <li><a href="https://twitter.com/themalwareguy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/MalwareGuy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.youtube.com/channel/UCKLRrI3yzes4p8GpWAdwevg" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-youtube" aria-hidden="true"></i> YouTube</a></li>
        
      
        
          <li><a href="https://discord.gg/kvU3kvt4Qb" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-discord" aria-hidden="true"></i> Discord</a></li>
        
      
        
          <li><a href="https://www.instagram.com/malware_guy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-instagram" aria-hidden="true"></i> Instagram</a></li>
        
      
        
          <li><a href="https://infosec.exchange/@malware_guy" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-mastodon" aria-hidden="true"></i> Mastodon</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Malware Guy. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>. PS: If you knowingly stumble upon any malware from my hunts and end up downloading it and infecting yourself, I will point and laugh at you. I hold no liability over the cat's curiosity if it gets the better of them!</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
